{"version":3,"sources":["chatPage/pages/chat/chat.js"],"names":["app","getApp","md5","require","app_key","app_id","session","interstitialAd","adList","Page","data","chatList","inputValue","userName","userImg","id","robot","showImg","that","wx","previewImage","urls","current","genRequestSign","params","sortObject","paramStr","keys","Object","idx","key","encodeURIComponent","hexMD5","toUpperCase","obj","sort","newObj","i","length","chat","e","indexs","setData","type","text","detail","value","time_stamp","parseInt","Date","getTime","toString","nonce_str","Math","random","substr","question","wxrequest","url","method","header","success","res","hideLoading","index","answer","fail","complete","getUserInfo","userInfo","nickName","avatarUrl","onLoad","gs","su","loading","cloud","getPhotoKey","then","k","onReady","onShow","createInterstitialAd","adUnitId","floor","show","catch","err","console","error","onHide","onUnload","onPullDownRefresh","onShareAppMessage","title","path"],"mappings":"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","file":"chat.js","sourcesContent":["/*eslint-disable*/\n// 获取全局应用程序实例对象\nconst app = getApp()\nconst md5 = require('./wxmd5')\nlet app_key = null\nlet app_id = null\nlet session = null\nlet interstitialAd = null\nlet adList = ['adunit-4f07cc10a5456874', 'adunit-6e87d676cfe14f11', 'adunit-052131219397beeb', 'adunit-4f07cc10a5456874', 'adunit-6e87d676cfe14f11', 'adunit-052131219397beeb', 'adunit-4f07cc10a5456874', 'adunit-6e87d676cfe14f11', 'adunit-052131219397beeb', 'adunit-052131219397beeb']\n// 创建页面实例对象\nPage({\n  /**\n   * 页面的初始数据\n   */\n  data: {\n    chatList: [],\n    inputValue: null,\n    userName: '匿名用户--点击头像进行授权',\n    userImg: 'https://c.jiangwenqiang.com/api/logo.jpg',\n    id: 0,\n    robot: 'https://7465-teach-1258324355.tcb.qcloud.la/image/eva_1.jpg'\n  },\n  showImg () {\n    let that = this\n    wx.previewImage({\n      urls: [that.data.robot],\n      current: that.data.robot\n    })\n  },\n  genRequestSign (params)  {\n    // 1. 对请求参数按字典升序排序\n    params = this.sortObject(params)\n    // 2. 拼接键值对，value部分进行URL编码\n    let paramStr = ''\n    let keys = Object.keys(params)\n    for (let idx in keys) {\n      let key = keys[idx]\n      paramStr += key + '=' + encodeURIComponent(params[key]) + '&'\n    }\n    // 3. 拼接key\n    paramStr += 'app_key=' + app_key\n    // 4. md5\n    return md5.hexMD5(paramStr).toUpperCase()\n  },\n  sortObject (obj)  {\n    var keys = Object.keys(obj).sort()\n    var newObj = {}\n    for (var i = 0; i < keys.length; i++) {\n      newObj[keys[i]] = obj[keys[i]]\n    }\n    return newObj\n  },\n  chat (e) {\n    let that = this\n    let indexs = that.data.chatList.length\n    if (e) {\n      this.setData({\n        inputValue: null,\n        [`chatList[${indexs}]`]: {\n          type: 2,\n          text: e.detail.value.length <= 0 ? '我也不知道说些什么' : e.detail.value\n        }\n      })\n    }\n    let params = {\n      app_id: app_id,\n      time_stamp: parseInt(new Date().getTime() / 1000).toString(),\n      nonce_str: Math.random().toString(36).substr(2),\n      session,\n      question: e ? e.detail.value : 'EVA，你好呀',\n    }\n    params['sign'] = this.genRequestSign(params)\n    app.wxrequest({\n      url: 'https://api.ai.qq.com/fcgi-bin/nlp/nlp_textchat',\n      method: 'POST',\n      header: 'application/x-www-form-urlencoded',\n      data: params,\n      success (res) {\n        wx.hideLoading()\n        let index = that.data.chatList.length\n        if (!res.data.data.answer.length) {\n          that.setData({\n            id: index,\n            [`chatList[${index}]`]: {\n              type: 1,\n              text: '不知道说什么，那不如看看我的小广告'\n            }\n          })\n        } else {\n          that.setData({\n            id: index,\n            [`chatList[${index}]`]: {\n              type: 1,\n              text: res.data.data.answer\n            }\n          })\n        }\n      },\n      fail () {\n\n      },\n      complete () {\n        wx.hideLoading()\n      }\n    })\n  },\n  getUserInfo (e) {\n    if (e.detail.userInfo) {\n      this.setData({\n        userName: e.detail.userInfo.nickName,\n        userImg: e.detail.userInfo.avatarUrl\n      })\n    }\n  },\n  onLoad () {\n    let that = this\n    wx.getUserInfo({\n      success (res) {\n        if (res.userInfo) {\n          that.setData({\n            userName: res.userInfo.nickName,\n            userImg: res.userInfo.avatarUrl\n          })\n        }\n      }\n    })\n    if (!app.gs('session')) {\n      session = Math.random().toString(36).substr(2)\n      app.su('session', session)\n    } else {\n      session = app.gs('session')\n    }\n    this.setData({\n      loading: true\n    })\n    app.cloud().getPhotoKey()\n      .then(res => {\n        app_key = res.k\n        app_id = res.i\n        that.setData({\n          loading: false\n        }, that.chat)\n      })\n  },\n\n  /**\n   * 生命周期函数--监听页面初次渲染完成\n   */\n  onReady () {\n    // TODO: onReady\n  },\n\n  /**\n   * 生命周期函数--监听页面显示\n   */\n  onShow () {\n    // 在页面中定义插屏广告\n\n// 在页面onLoad回调事件中创建插屏广告实例\n    if (wx.createInterstitialAd) {\n      interstitialAd = wx.createInterstitialAd({\n        adUnitId: adList[Math.floor(Math.random() * 10)]\n      })\n    }\n// 在适合的场景显示插屏广告\n    if (interstitialAd) {\n      interstitialAd.show().catch((err) => {\n        console.error(err)\n      })\n    }\n    // TODO: onShow\n  },\n\n  /**\n   * 生命周期函数--监听页面隐藏\n   */\n  onHide () {\n    // TODO: onHide\n  },\n\n  /**\n   * 生命周期函数--监听页面卸载\n   */\n  onUnload () {\n    // TODO: onUnload\n  },\n\n  /**\n   * 页面相关事件处理函数--监听用户下拉动作\n   */\n  onPullDownRefresh () {\n\n  },\n  onShareAppMessage: function () {\n    return {\n      title: '向您推荐一个有趣的小程序，快来围观吧',\n      path: '/pages/index/index'\n    }\n  }\n})\n"]}